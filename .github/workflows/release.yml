name: Release

on:
  schedule:
    # Check for new Claude Code versions daily at 06:00 UTC
    - cron: "0 6 * * *"
  workflow_dispatch:
    inputs:
      claude_version:
        description: "Claude Code version to release for (leave empty to auto-detect)"
        required: false
      skip_e2e:
        description: "Skip E2E tests (unit tests still run)"
        type: boolean
        default: false

permissions:
  contents: write
  packages: write

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/synix-proxy

jobs:
  # ── Detect Claude Code version ────────────────────────────────────────
  check-version:
    runs-on: ubuntu-latest
    outputs:
      claude_version: ${{ steps.detect.outputs.version }}
      needs_release: ${{ steps.detect.outputs.needs_release }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect latest Claude Code version
        id: detect
        run: |
          if [ -n "${{ inputs.claude_version }}" ]; then
            VERSION="${{ inputs.claude_version }}"
            echo "Manual version: $VERSION"
          else
            VERSION=$(npm view @anthropic-ai/claude-code version 2>/dev/null || echo "")
            if [ -z "$VERSION" ]; then
              echo "Failed to detect Claude Code version"
              echo "needs_release=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            echo "Latest Claude Code: $VERSION"
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          if git tag -l "v$VERSION" | grep -q "v$VERSION"; then
            echo "Tag v$VERSION already exists — no release needed"
            echo "needs_release=false" >> "$GITHUB_OUTPUT"
          else
            echo "New version: $VERSION"
            echo "needs_release=true" >> "$GITHUB_OUTPUT"
          fi

  # ── Unit tests ────────────────────────────────────────────────────────
  test:
    needs: check-version
    if: needs.check-version.outputs.needs_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --dev
      - run: uv run pytest tests/ -x -v --tb=short -k "not ci_e2e"

  # ── Build container image ─────────────────────────────────────────────
  build:
    needs: [check-version, test]
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.check-version.outputs.claude_version }}
    steps:
      - uses: actions/checkout@v4

      - name: Build image
        run: docker build --build-arg VERSION=$VERSION -t synix-proxy:test .

      - name: Smoke test — health endpoint
        run: |
          docker run -d --name smoke \
            -p 127.0.0.1:47200:47200 -p 127.0.0.1:47201:443 \
            synix-proxy:test
          for i in $(seq 1 30); do
            if curl -fsk https://localhost:47201/health 2>/dev/null; then
              echo " Healthy!"
              break
            fi
            sleep 1
          done
          curl -fsk https://localhost:47201/health | python3 -c "
          import json, sys
          d = json.load(sys.stdin)
          assert d['status'] == 'ok', f'Bad status: {d}'
          print('Health OK')
          "
          docker rm -f smoke

      - name: Save image for E2E
        run: |
          docker save synix-proxy:test | gzip > /tmp/image.tar.gz

      - uses: actions/upload-artifact@v4
        with:
          name: container-image
          path: /tmp/image.tar.gz
          retention-days: 1

  # ── E2E test with real API calls ──────────────────────────────────────
  e2e:
    needs: [check-version, build]
    if: needs.check-version.outputs.needs_release == 'true' && !inputs.skip_e2e
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      VERSION: ${{ needs.check-version.outputs.claude_version }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: container-image
          path: /tmp

      - name: Load image
        run: docker load < /tmp/image.tar.gz

      - name: Start proxy container
        run: |
          mkdir -p certs data logs
          docker run -d --name dbproxy \
            -p 127.0.0.1:47200:47200 \
            -p 127.0.0.1:47201:443 \
            -v $PWD/certs:/app/certs \
            -v $PWD/data:/app/data \
            -v $PWD/logs:/app/logs \
            -e SYNIX_HOST=0.0.0.0 \
            -e SYNIX_LOG_LEVEL=INFO \
            -e SYNIX_CHECKPOINT_THRESHOLD=0.25 \
            -e SYNIX_SWAP_THRESHOLD=0.26 \
            synix-proxy:test
          echo "Waiting for health..."
          for i in $(seq 1 30); do
            if curl -fsk https://localhost:47201/health; then
              echo ""
              break
            fi
            sleep 1
          done

      - name: Smoke test — Claude Code compatibility
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          npm install -g @anthropic-ai/claude-code@$VERSION
          export HTTPS_PROXY=http://127.0.0.1:47200
          export NODE_EXTRA_CA_CERTS=$PWD/certs/ca.pem
          # Single non-interactive request through the proxy
          claude -p "Say 'proxy test ok' and nothing else." --output-format text \
            --model claude-haiku-4-5-20251001 \
            2>/dev/null | tee /tmp/claude-output.txt
          grep -qi "ok\|proxy" /tmp/claude-output.txt && echo "Claude Code smoke test PASSED"

      - name: E2E lifecycle test
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PROXY_PORT: "47200"
          DASHBOARD_PORT: "47201"
          CA_CERT: "certs/ca.pem"
          MAX_ROUNDS: "30"
          TIMEOUT_SECONDS: "900"
        run: python tests/ci_e2e.py

      - name: Dump logs on failure
        if: failure()
        run: |
          echo "=== Container logs ==="
          docker logs dbproxy 2>&1 | tail -100
          echo "=== Proxy logs ==="
          cat logs/dbproxy.jsonl 2>/dev/null | tail -50
          echo "=== Redirector log ==="
          docker exec dbproxy cat /tmp/redirector.log 2>/dev/null | tail -20

      - name: Cleanup
        if: always()
        run: docker rm -f dbproxy 2>/dev/null || true

  # ── Push image + create release ───────────────────────────────────────
  release:
    needs: [check-version, build, e2e]
    if: |
      always() &&
      needs.check-version.outputs.needs_release == 'true' &&
      needs.build.result == 'success' &&
      (needs.e2e.result == 'success' || needs.e2e.result == 'skipped')
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.check-version.outputs.claude_version }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: container-image
          path: /tmp

      - name: Load image
        run: docker load < /tmp/image.tar.gz

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag and push image
        run: |
          docker tag synix-proxy:test ${{ env.IMAGE_NAME }}:${{ env.VERSION }}
          docker tag synix-proxy:test ${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.IMAGE_NAME }}:${{ env.VERSION }}
          docker push ${{ env.IMAGE_NAME }}:latest

      - name: Update version and tag
        run: |
          sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml
          git commit -m "release: v$VERSION (Claude Code $VERSION)" || true
          git tag -a "v$VERSION" -m "Release v$VERSION — tested with Claude Code $VERSION"
          git push origin main --tags

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: v${{ env.VERSION }}
          body: |
            ## Synix v${{ env.VERSION }}

            Tested and verified with **Claude Code v${{ env.VERSION }}**.

            ### Install
            ```sh
            curl -fsSL https://synix.dev/proxy | sh
            ```

            ### Container Image
            ```sh
            docker pull ${{ env.IMAGE_NAME }}:${{ env.VERSION }}
            ```
          generate_release_notes: true
